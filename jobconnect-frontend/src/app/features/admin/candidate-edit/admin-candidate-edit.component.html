<div class="cv-builder" *ngIf="!loading()">
    <!-- Hero Header -->
    <div class="page-header">
        <div class="header-orb header-orb-1"></div>
        <div class="header-orb header-orb-2"></div>

        <!-- Top Navigation Bar -->
        <div class="header-nav">
            <button class="back-btn" (click)="goBack()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
                <span>Back to Candidates</span>
            </button>

            <div class="header-badge">
                <div class="badge-glow"></div>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="badge-icon">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                <span>Admin Panel</span>
            </div>
        </div>

        <!-- Page Title -->
        <div class="header-content">
            @if (isNewCandidate()) {
            <h1>Add New <span class="gradient-text">Candidate</span></h1>
            <p>Create a new candidate account with their profile information</p>
            } @else {
            <h1>Edit <span class="gradient-text">Candidate Profile</span></h1>
            <p>Update the candidate's profile, experience, education, and skills</p>
            }
        </div>
    </div>

    <div class="cv-container">
        <!-- Form Section -->
        <div class="form-section">
            <form [formGroup]="cvForm">
                <!-- Personal Info -->
                <div class="card" formGroupName="personalInfo">
                    <h2><i class="icon-user"></i> Personal Information</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" formControlName="firstName" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" formControlName="lastName" placeholder="Doe">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" formControlName="email" placeholder="john@example.com">
                        </div>
                        @if (isNewCandidate()) {
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" formControlName="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        }
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" formControlName="phone" placeholder="+33 6 12 34 56 78">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" formControlName="location" placeholder="Paris, France">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label>Professional Summary</label>
                        <textarea formControlName="summary" rows="4"
                            placeholder="Brief overview of the candidate's professional background..."></textarea>
                    </div>
                </div>

                <!-- Skills -->
                <div class="card">
                    <h2><i class="icon-star"></i> Skills</h2>
                    <div class="skills-grid">
                        @for (skill of skills(); track skill.id) {
                        <button type="button" class="skill-chip" [class.selected]="isSkillSelected(skill.id)"
                            (click)="toggleSkill(skill.id)">
                            {{ skill.name }}
                            <span class="category">{{ skill.category }}</span>
                        </button>
                        }
                    </div>
                </div>

                @if (!isNewCandidate()) {
                <!-- Experience -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="icon-briefcase"></i> Work Experience</h2>
                        <button type="button" class="btn-add" (click)="addExperience()">
                            + Add Experience
                        </button>
                    </div>

                    @for (exp of experienceArray.controls; track $index; let i = $index) {
                    <div class="nested-form" [formGroup]="$any(exp)">
                        <button type="button" class="btn-remove" (click)="removeExperience(i)">√ó</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Company *</label>
                                <input type="text" formControlName="company" placeholder="Company Name">
                            </div>
                            <div class="form-group">
                                <label>Job Title *</label>
                                <input type="text" formControlName="title" placeholder="Software Engineer">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Start Date</label>
                                <app-date-picker formControlName="startDate"
                                    placeholder="Select start date"></app-date-picker>
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <app-date-picker formControlName="endDate" placeholder="Select end date"
                                    [disabled]="exp.get('isCurrentRole')?.value">
                                </app-date-picker>
                            </div>
                            <div class="form-group checkbox">
                                <label>
                                    <input type="checkbox" formControlName="isCurrentRole">
                                    Current Role
                                </label>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label>Description</label>
                            <textarea formControlName="description" rows="3"
                                placeholder="Key responsibilities and achievements..."></textarea>
                        </div>
                    </div>
                    }
                </div>

                <!-- Education -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="icon-graduation"></i> Education</h2>
                        <button type="button" class="btn-add" (click)="addEducation()">
                            + Add Education
                        </button>
                    </div>

                    @for (edu of educationArray.controls; track $index; let i = $index) {
                    <div class="nested-form" [formGroup]="$any(edu)">
                        <button type="button" class="btn-remove" (click)="removeEducation(i)">√ó</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Institution *</label>
                                <input type="text" formControlName="institution" placeholder="University Name">
                            </div>
                            <div class="form-group">
                                <label>Degree *</label>
                                <input type="text" formControlName="degree" placeholder="Bachelor's, Master's...">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Field of Study *</label>
                                <input type="text" formControlName="field" placeholder="Computer Science">
                            </div>
                            <div class="form-group">
                                <label>Graduation Year</label>
                                <input type="number" formControlName="graduationYear" min="1950" max="2030">
                            </div>
                        </div>
                    </div>
                    }
                </div>

                <!-- Certifications -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="icon-certificate"></i> Certifications</h2>
                        <button type="button" class="btn-add" (click)="addCertification()">
                            + Add Certification
                        </button>
                    </div>

                    @for (cert of certificationsArray.controls; track $index; let i = $index) {
                    <div class="nested-form" [formGroup]="$any(cert)">
                        <button type="button" class="btn-remove" (click)="removeCertification(i)">√ó</button>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Certification Name *</label>
                                <input type="text" formControlName="name" placeholder="AWS Solutions Architect">
                            </div>
                            <div class="form-group">
                                <label>Issuing Organization *</label>
                                <input type="text" formControlName="issuer" placeholder="Amazon Web Services">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Issue Date</label>
                                <app-date-picker formControlName="issueDate"
                                    placeholder="Select issue date"></app-date-picker>
                            </div>
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <app-date-picker formControlName="expiryDate"
                                    placeholder="Select expiry date"></app-date-picker>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                }

                <!-- Save Button for New Candidates -->
                @if (isNewCandidate()) {
                <div class="save-actions">
                    <button type="button" class="btn-secondary" (click)="goBack()">Cancel</button>
                    <button type="button" class="btn-primary" (click)="saveCandidate()" [disabled]="saving()">
                        @if (saving()) {
                        <span class="btn-spinner"></span>
                        Creating...
                        } @else {
                        Create Candidate
                        }
                    </button>
                </div>
                }
            </form>
        </div>

        <!-- Live Preview Section -->
        <div class="preview-section">
            <div class="preview-header">
                <h2>Live Preview</h2>
                <div class="preview-badges">
                    @if (!isNewCandidate()) {
                    <div class="autosave-status" [class.saving]="saving()" [class.saved]="!saving()">
                        @if (saving()) {
                        <span class="status-icon">‚ü≥</span>
                        <span>Saving...</span>
                        } @else {
                        <span class="status-icon">‚úì</span>
                        <span>Saved</span>
                        }
                    </div>
                    }
                    <span class="preview-badge">
                        <span class="pulse-dot"></span>
                        Real-time
                    </span>
                </div>
            </div>

            <div class="cv-preview" *ngIf="previewData()">
                <div class="preview-personal">
                    <h1 class="preview-name">
                        {{ previewData()?.personalInfo?.firstName || 'First' }}
                        {{ previewData()?.personalInfo?.lastName || 'Last' }}
                    </h1>
                    @if (previewData()?.personalInfo?.email) {
                    <p class="preview-email">‚úâÔ∏è {{ previewData()?.personalInfo?.email }}</p>
                    }
                    @if (previewData()?.personalInfo?.location) {
                    <p class="preview-location">üìç {{ previewData()?.personalInfo?.location }}</p>
                    }
                    @if (previewData()?.personalInfo?.phone) {
                    <p class="preview-phone">üìû {{ previewData()?.personalInfo?.phone }}</p>
                    }
                </div>

                @if (previewData()?.personalInfo?.summary) {
                <div class="preview-section-block">
                    <h3>About</h3>
                    <p>{{ previewData()?.personalInfo?.summary }}</p>
                </div>
                }

                @if (previewData()?.skills?.length) {
                <div class="preview-section-block">
                    <h3>Skills</h3>
                    <div class="preview-skills">
                        @for (skill of previewData()?.skills; track skill.id) {
                        <span class="preview-skill-tag">{{ skill.name }}</span>
                        }
                    </div>
                </div>
                }

                @if (previewData()?.experience?.length) {
                <div class="preview-section-block">
                    <h3>Experience</h3>
                    @for (exp of previewData()?.experience; track $index) {
                    <div class="preview-item">
                        <div class="preview-item-header">
                            <strong>{{ exp.title || 'Position' }}</strong>
                            @if (exp.startDate) {
                            <span class="preview-dates">
                                {{ exp.startDate | date:'MMM yyyy' }} -
                                @if (exp.isCurrentRole) { Present } @else { {{ exp.endDate | date:'MMM yyyy' }} }
                            </span>
                            }
                        </div>
                        <span class="preview-company">{{ exp.company || 'Company' }}</span>
                        @if (exp.description) {
                        <p class="preview-description">{{ exp.description }}</p>
                        }
                    </div>
                    }
                </div>
                }

                @if (previewData()?.education?.length) {
                <div class="preview-section-block">
                    <h3>Education</h3>
                    @for (edu of previewData()?.education; track $index) {
                    <div class="preview-item">
                        <div class="preview-item-header">
                            <strong>{{ edu.degree || 'Degree' }} in {{ edu.field || 'Field' }}</strong>
                            @if (edu.graduationYear) {
                            <span class="preview-dates">{{ edu.graduationYear }}</span>
                            }
                        </div>
                        <span class="preview-company">{{ edu.institution || 'Institution' }}</span>
                    </div>
                    }
                </div>
                }

                @if (previewData()?.certifications?.length) {
                <div class="preview-section-block">
                    <h3>Certifications</h3>
                    @for (cert of previewData()?.certifications; track $index) {
                    <div class="preview-item">
                        <div class="preview-item-header">
                            <strong>{{ cert.name || 'Certification' }}</strong>
                            @if (cert.issueDate) {
                            <span class="preview-dates">{{ cert.issueDate | date:'MMM yyyy' }}</span>
                            }
                        </div>
                        <span class="preview-company">{{ cert.issuer || 'Issuer' }}</span>
                    </div>
                    }
                </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="loading()">
    <div class="spinner"></div>
    <p>Loading candidate profile...</p>
</div>